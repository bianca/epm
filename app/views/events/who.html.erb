<%
  tit = 'Who'
  if @event.cancelled?
    tit += ' Would Have Come'
  else
    tit += @event.past? ? ' Went' : '’s Coming'
  end
  title "#{tit} to ‘#{@event.display_name(current_user)}’"
%>

<% content_for :header do %>
  <%= link_to "#{Configurable.event.titlecase} Details", @event %>

  <%# this is duplicated in who.html.erb %>
  <% if can?(:claim, @event) && !@event.cancelled? && !@event.past? %>
    <%= link_to "Claim This #{Configurable.event.titlecase}", claim_event_path(@event), method: :patch %>
  <% elsif can?(:unclaim, @event) && @event.proposed? && @event.coordinator == current_user %>
    <%= link_to "Unclaim This #{Configurable.event.titlecase}", unclaim_event_path(@event), method: :patch %>
  <% end %>

  <%= link_to('Edit Attendance', take_attendance: true) if @can_take_attendance && !@taking_attendance %>
<% end %>

<%= start_cols %>
<% if @taking_attendance %>
  <%= form_for @event, url: take_attendance_event_path(@event), method: :patch do |f| %>
    <fieldset class="users">
      <legend>Attendance</legend>
      Check those who attended.
      <% @event.event_users.where(status: EventUser.statuses_array(:attending, :attended, :no_show)).each do |eu| %>
        <label>
          <%= check_box_tag "attendance[#{eu.id}]", true, eu.attended? %>
          <%= render 'users/user', user: eu.user %>
        </label>
      <% end %>
    </fieldset>
    <fieldset class="details">
      <legend>Post-Pick Details</legend>



      <%= f.label :lbs_to_agency, "Pounds of fruit delivered to agency" %>
      <%= f.text_field :lbs_to_agency %>
      <br />      
     <% if Agency.any? %>
      <fieldset id="agency">
        <%= f.label :agency_id, "Which agency recieved the fruit?" %>
        <%= f.collection_select :agency_id, Agency.all, :id, :title, include_blank: true %>
      </fieldset>
    <% end %>   

      <%= f.label :fun, "Fun Factor" %>
      <%= f.select(:fun, options_for_select(Event.fun_labels, @event.fun), include_blank: true) %>
      <br />
      <%= f.label :first_aid, "Any first aid issues?" %><br />
      <%= f.text_area :first_aid %>
      <br />

      What should NFFTT should know - or take action on - before next season?<br />
      <span style="font-style: italic; font-size: 13px">Tell us if the tree is too high and not worth picking, the property is dangerous, or there was an unhappy homeowner.</span>
      <%= text_area_tag "property_notes" %>

      Do you have any positive or negative feedback about specific volunteers?
      <%= text_area_tag "volunteer_notes" %>
      <br />
      <br />

      Were there any issues with the equipment set?
       <%= text_area_tag "equipment_set_notes" %>

    </fieldset>

<%= next_col %>

      <% 
        @tree_type_counts = {}
        @event.event_trees.each do |event_tree| 
          if @tree_type_counts.has_key?(event_tree.tree.species) == false
            @tree_type_counts[event_tree.tree.species] = 1
          else 
            @tree_type_counts[event_tree.tree.species] += 1
          end
        end
      %>

      <script language="javascript">
          $(document).ready(function () { 
            $(document).keypress(function(e) {
                if(e.which == 13) {
                    e.preventDefault();
                }
            });
            $('.update_pounds').change(function (evt) {
              console.log("update_pounds")
                // whatever that berry is, redistribute that 
                var id = $(this).attr("id")
                treetype = id.replace("trees_picked_","").replace("pounds_picked_","")
                var limit = $("#trees_picked_"+treetype).val()
                var pounds = $("#pounds_picked_"+treetype).val() 
                console.log(treetype,limit,pounds)
                if (!!limit && !!pounds) {
                  var distributed_pounds = parseInt(pounds)/limit
                  var count = 0;
                  $('.'+treetype).each(function (evt) {
                      if (count < limit) {
                        $(this).val(distributed_pounds)
                        count++
                      } else {
                        $(this).val(0)
                      }
                  })
                }
            })

            $('select.update_quality').change(function (evt) {
                // whatever that type is, assign that elsewhere
                var v = $(this).val()
                var id = $(this).attr("id")
                console.log(v, id)
                treetype = id.replace("quality_","")
                  $('.'+treetype+"_quality").each(function (evt) {
                    $(this).val(v)
                  })
            })
          })
      </script>
      <div style="font-size: 16px; border: 2px solid #999; padding: 10px; margin: 10px">
      <p>
      Use this box to fill out information for each tree type. It will fill out the information for each individual tree below.
      </p>
      <% 
        trees_picked = {}
        pounds_picked = {}
        @tree_type_counts.each do |tree_type,tree_count| 
          %> 

            # of <%=tree_type %> trees picked <%= text_field_tag "trees_picked[#{tree_type}]", tree_count, size: 3, class: "update_pounds" %>, # of pounds of <%=tree_type %> fruit picked <%= text_field_tag "pounds_picked[#{tree_type}]", '', size: 3, class: "update_pounds" %>
            <br /> <%=tree_type %> quality: <%= select_tag("quality[#{tree_type}]",options_for_select(Tree.quality_labels), include_blank: true, class: "update_quality") %>
            <br /> <br />
          
          <%
        end
      %>
      </div>
    <fieldset class="trees">
      <% @event.event_trees.each do |event_tree| %>
        <fieldset id="<%=event_tree.tree.id %>" style="border: 2px solid #999; padding: 10px; margin: 10px">
        <h3> Info for <%=event_tree.tree.species %> <%if event_tree.tree.subspecies.present? %>(<%=event_tree.tree.subspecies %>)<% end %> Tree</h3>
        <%= f.fields_for "event_tree[]", event_tree do |et| %>
          <%#= et.hidden #{event_tree.tree.id} %> 
          <%= et.label :lbs_picked, "Pounds picked" %>
          <%= et.text_field :lbs_picked, class: event_tree.tree.species %>
          <br />
          <%= et.label :quality, "Quality" %>
          <%= et.hidden_field :quality %>
          <%= et.select(:quality,  options_for_select(Tree.quality_labels, selected=event_tree.quality), {include_blank: true}, {class: "#{event_tree.tree.species}_quality"})  %>
          <br />
          <%= et.label :quality_issues, "Quality Issues (if any)" %><br />
          <%= et.text_area :quality_issues %>
        <% end %>
        </fieldset>
      <% end %>
    </fieldset>


    <%= submit 'Submit' %>
  <% end %>
  <% content_for :js_ready do %>
    $('fieldset.users label:first')
      .before('<br>')
      .before($('<button type="button" class="default">Check All</button>').click(function(){
          $('fieldset.users input').prop('checked', true);
        })
      );
  <% end %>
<% end %>

<%# no need to tell coordinators they're attending, as they are listed already, right after this %>
<%= render('rsvp') unless (@event.coordinator == current_user) || @event.cancelled? %>

<% if @show_invites || @show_invite %>
  <section>
    <h2>Invitations</h2>
    <% if @num_invited > 0 %>
      <p><%= pluralize @num_invited, 'invitation' %> <%= 'is'.pluralize(@num_invited) %> awaiting a response (<%= Invitation.where(event_id: @event.id).count %> unsent).</p>
    <% end %>
    <% if @num_declined > 0 %>
      <p><%= pluralize @num_declined, 'invitation' %> <%= 'was'.pluralize(@num_declined) %> declined.</p>
    <% end %>
    <%= button_to("Invite #{Configurable.participant.pluralize.titlecase}", invite_event_path(@event), method: :patch) if @show_invite %>
<% end %>

<section>
  <h2><%= Configurable.coordinator.titlecase %></h2>
  <% if @event.coordinator %>
    <%= render 'users/user', user: @event.coordinator %>
  <% else %>
    None set.
  <% end %>
</section>


<% if @event.can_have_participants? && !@taking_attendance %>

  <section id="participants">
    <h2>
      <%= pluralize @event.participants.count, Configurable.participant.titlecase %>
      <% if @event.can_accept_participants? %>
        &ndash;
        <% if @event.participants_needed > 0 %>
          <%= @event.participants_needed %> More Needed
        <% elsif @event.full? %>
          Full
        <% else %>
          <%
            spots = @event.remaining_spots
            spots = 'Unlimited' if spots == true
          %>
          <%= pluralize spots, 'Spot' %> Left
        <% end %>
      <% end %>
    </h2>
    <% if @event.participants.any? %>
      <%= render 'users/users', users: @event.participants %>
    <% else %>
      <p>None<%= ' yet' if !@event.past? %>.</p>
    <% end %>
  </section>

  <% if @event.no_shows.any? %>
    <section id="no_show_participants">
      <h2><%= pluralize @event.no_shows.count, "Absent #{Configurable.participant.titlecase}" %></h2>
      <%= render 'users/users', users: @event.no_shows %>
    </section>
  <% end %>

  <% if (current_user.has_role?(:admin) || current_user == @event.coordinator) && @event.approved? && !@event.past? && @event.waitlisted.any? %>
    <section id="waitlisted">
      <h2><%= @event.waitlisted.count %> Waitlisted</h2>
      <%= render 'users/users', users: @event.waitlisted %>
    </section>
  <% end %>

<% end %>
<%= end_cols %>