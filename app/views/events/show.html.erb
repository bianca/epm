<%
  tit = @event.display_name(current_user)
  tit = "#{@event.status.capitalize}: #{tit}" unless @event.approved?
  title tit
%>

<% content_for :header do %>

  <%
    who_link = 'Who'
    unless @event.cancelled?
      who_link += "#{@event.past? ? ' Went' : 'â€™s Coming'} (#{@event.users.length})"
    end
  %>
  <%= link_to who_link, who_event_path(@event) %>

  <% if can? :update, @event %>
    <%= link_to 'Edit', edit_event_path(@event) %>
  <% end %>
  <% if can?(:approve, @event) && @event.proposed? %>
    <%= link_to 'Approve', approve_event_path(@event), method: :patch %>
  <% end %>
  <% if can?(:cancel, @event) && !@event.cancelled? %>
    <%= link_to 'Cancel', cancel_event_path(@event) %>
  <% end %>

  <%= render 'invite', event: @event %>

<% end %>

<% if current_user.has_any_role?(:participant, :coordinator) || @buttons.any? %>
  <div id="rsvp">
    <%= @attend_str %>
    <% if @buttons.any? %>
      <% @buttons.each do |type, label| %>
        <%= button_to label, send("#{type}_event_path", @event), method: :patch %>
      <% end %>
      <% if @buttons[:attend] && @event.participants_needed > 0 %>
        <br><%= pluralize @event.participants_needed, 'participant' %> still needed!
      <% end %>
    <% end %>
  </div>
<% end %>

<%# todo: better division of cola vs colb, depending on what stuff there is %>
<%= start_cols %>

<% if @event.notes.present? && can?(:read_notes, @event) %>
  <div id="notes">
    <strong>Notes for Admins and Coordinators</strong>
    <%= paragraphs @event.notes %>
  </div>
<% end %>
<%= paragraphs @event.description if @event.description.present? %>
<%= next_col if @event.description.present? || (@event.notes.present? && can?(:read_notes, @event)) %>

<div>
  <% if @event.start %>
    <div id="date"><p><%= date @event.start %></p></div>
    <% content_for :js_ready do %>
      $('#date').html('').datepicker({
        dateFormat: 'yy-mm-dd',
        defaultDate: "<%= @event.start.to_date %>",
        nextText: '',
        prevText: '',
        disabled: true
      });
    <% end %>
    <p><%= time @event.start %> to <%= time @event.finish %> (<%= pluralize @event.duration_hours, 'hour' %>)</p>
  <% else %>
    <p>No date set.</p>
  <% end %>
</div>

<% if @event.address || @event.coords %>
  <% coords = @event.coords(current_user) %>
  <section id="where"<%= "data-map=\"true\" data-lat=\"#{coords[0]}\" data-lng=\"#{coords[1]}\"".html_safe if coords %>>
    <h2>Where</h2>
    <%= with_br(@event.address) if @event.address && can?(:read_specific_location, @event) %>
    <% if @event.coords %>
      <% content_for :js_ready do %>
        <% if cannot? :read_specific_location, @event %>
          $('.map').before('note: exact location and address shown only to attendees');
        <% end %>
      <% end %>
    <% end %>
  </section>
<% end %>

<%= end_cols %>