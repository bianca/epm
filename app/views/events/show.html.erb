<%
  tit = @event.display_name
  tit = "#{@event.status.capitalize}: #{tit}" unless @event.approved?
  title tit
%>

<% if can? :update, @event %>
  <%= link_to 'Edit', edit_event_path(@event) %>
<% end %>
<% if can?(:approve, @event) && @event.proposed? %>
  <%= link_to 'Approve', approve_event_path(@event), method: :patch %>
<% end %>
<% if can?(:destroy, @event) && !@event.cancelled? %>
  <%= link_to 'Cancel', @event, method: :delete, data: { confirm: 'Are you sure?' } %>
<% end %>

<% if @event.participatable_by? current_user %>
  <p><strong>
    <% if @event.participants.include? current_user %>
      <%= link_to 'Cancel RSVP', unattend_event_path(@event), method: :patch %>
    <% else %>
      <%= link_to 'Join', attend_event_path(@event), method: :patch %>
    <% end %>
  </strong></p>
<% end %>

<%= start_cols %>

<% if @event.notes.present? && can?(:read_notes, @event) %>
  <div id="notes">
    <strong>Notes for Admins and Coordinators</strong>
    <%= paragraphs @event.notes %>
  </div>
<% end %>
<%= paragraphs @event.description if @event.description.present? %>
<%= next_col if @event.description.present? || (@event.notes.present? && can?(:read_notes, @event)) %>

<div>
  <% if @event.start %>
    <div id="date"><p><%= date @event.start %></p></div>
    <% content_for :js_ready do %>
      $('#date').html('').datepicker({
        dateFormat: 'yy-mm-dd',
        defaultDate: "<%= @event.start.to_date %>",
        nextText: '',
        prevText: '',
        disabled: true
      });
    <% end %>
    <p><%= time @event.start %> to <%= time @event.finish %> (<%= pluralize @event.duration_hours, 'hour' %>)</p>
  <% else %>
    <p>No date set.</p>
  <% end %>
</div>

<% if @event.address || @event.coords %>
  <section id="where"<%= " data-lat=\"#{@event.lat}\" data-lng=\"#{@event.lng}\"".html_safe if @event.coords %>>
    <h2>Where</h2>
    <%= with_br(@event.address) if @event.address %>
  </section>
  <% if @event.coords %>
    <% content_for :js_ready do %>
      $('#where').append('<div id="map"></div>');
      var point = L.latLng($('#where').data('lat'), $('#where').data('lng'));
      var map = new L.Map('map', {
        center: point,
        zoom: 10,
        minZoom: 3,
        maxZoom: 18,
        layers: [new L.TileLayer('http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
          attribution: 'Data &copy; <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors; Tiles by <a href="http://www.mapquest.com/">MapQuest</a>',
          subdomains: ['otile1','otile2','otile3','otile4']
        })]
      });
      var marker = L.marker(point).addTo(map);
    <% end %>
  <% end %>
<% end %>

<%= end_cols %>

<section>

  <h2>Coordinator</h2>
  <% if @event.coordinator %>
    <%= render 'users/user', user: @event.coordinator %>
  <% else %>
    None set.
  <% end %>

  <% if @event.can_have_participants? %>
    <h2>Participants</h2>
    <% if @event.participants.any? %>
      <ul id="participants" class="users">
        <% @event.participants.each do |user| %>
          <%= render 'users/user', user: user, tag: 'li' %>
        <% end %>
      </ul>
    <% else %>
      <p>None yet.</p>
    <% end %>
  <% end %>

</section>