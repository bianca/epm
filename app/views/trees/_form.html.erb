<%= form_for @tree do |f| %>

   <%= render 'shared/errors', thing: @tree %>

<%= start_cols %>

    <%= f.hidden_field :owner_id %>

    <fieldset>
      <legend>Tree Type</legend>
        <div style="width: 33%; float: left; clear: none">
        <% Tree.types.each_with_index do |t,i| %>
          <% if i % ((Tree.types.count/3)+1) === 0 %>
              </div>
              <div style="width: 33%; float: left; clear: none">
          <% end %>
          <label style="clear: both; float: left">

          <%= f.radio_button :species, t.downcase %>
          <%= image_tag("fruits/#{t.downcase}32.png") %>
          <%= t %>
          </label>
        <% end %>
        </div>
        <div style="clear: both; float: left; margin-top: 10px">
          Other : <%= f.text_field :species_other %>
        </div>
    </fieldset>


    <div class="field">

      <%= f.label :subspecies, "Variety (If known)" %><br>
      <%= f.text_field :subspecies %>
    </div>  

    <div class="field">

      <%= f.label :ripen, "Ripening Date" %><br>
      <%= f.date_field :ripen, value: @tree.ripen %>
      <% content_for :js_ready do %>
        $('#tree_ripen').datepicker({
          dateFormat: 'yy-mm-dd',
          nextText: '»',
          prevText: '«',
          showButtonPanel: true,
          showOn: 'button',
          closeText: 'Okay',
          buttonText: '<%= @tree.ripen ? date(@tree.ripen) : 'Not set' %>',
          onSelect: function(){
            $('.ui-datepicker-trigger').text($.datepicker.formatDate('DD MM d, yy', $(this).datepicker('getDate')));
          }
        });
      <% end %>
    </div>  


    <div class="field">

      <%= f.label :height, "Tree Height" %><br>
      <%= f.select(:height, options_for_select(Tree.height_labels, @tree.height), include_blank: true) %>
    </div>  

    <div class="field">
      <%= f.label :treatment, "Has the tree been sprayed recently? If so, with what?" %><br>
      <%= f.text_area :treatment %>
    </div>

    <% if @tree.persisted? %>
      If this tree is not pickable anymore, let us know and tell us why:

      <div class="field">
        
        <%= f.check_box :pickable  %><%= f.label :pickable, "Yes, this tree is pickable" %>
      </div>

      <div class="field">
        <%= f.label :not_pickable_reason, "Reason why this tree is not pickable anymore:" %> <br>
        <%= f.text_area :not_pickable_reason %>
      </div>

    <% end %>

    <fieldset>
      <legend>Do you want to keep 1/3 of the fruit?</legend>
      <label style="margin:0 0.7em"><%= f.radio_button :keep, :yes %>Yes, please!</label>
      <label style="margin:0 0.7em"><%= f.radio_button :keep, :abit %>Just leave me a little.</label>
      <label style="margin:0 0.7em"><%= f.radio_button :keep, :no %>No thanks.</label>
    </fieldset> 


    <div class="field">
      <%= f.label :additional, "Is there anything else we should know?" %><br>
      <%= f.text_area :additional %>
    </div>


  <div class="actions">
    <% if @tree.new_record? %>
      <%= f.submit "Add Tree" %>
    <% else %>
      <%= f.submit "Save Changes" %>
    <% end %>
  </div>


<%= next_col %>

   <fieldset>
      <legend>Which best describes you?</legend>
      <label style="margin:0 0.7em"><%= f.radio_button :relationship, :propertyowner %>Property Owner</label>
      <label style="margin:0 0.7em"><%= f.radio_button :relationship, :tenant %>Tenant</label>
      <label style="margin:0 0.7em"><%= f.radio_button :relationship, :friend %>Friend</label>
      <br />
      <label style="margin:0 0.7em"><%= f.radio_button :relationship,'nopermission' %>I don't have permission to add this tree</label>
    </fieldset>

  <% content_for :js_ready do %>
        var toggle = function (value) {
          if (value == "propertyowner") {
            $("#propertyowner").show();
            $("#notpropertyowner").hide();
            $("#friend").hide();
            $("#tenant").hide();
            $("#permission_message").hide();
            $('input[name!="tree[relationship]"]').prop('disabled', false);
          } else if (value == "nopermission") {
            $("#permission_message").show();
            $("#friend").hide();
            $("#tenant").hide();
            $("#notpropertyowner").hide();
            $("#propertyowner").hide();
            $('input[name!="tree[relationship]"]').prop('disabled', true);
          } else if (value == "friend") {
            $("#propertyowner").hide();
            $("#notpropertyowner").show();
            $("#friend").show();
            $("#tenant").hide();
            $("#permission_message").hide();
            $('input[name!="tree[relationship]"]').prop('disabled', false);
          } else if (value == "tenant") {
            $("#propertyowner").hide();
            $("#notpropertyowner").show();
            $("#friend").hide();
            $("#tenant").show();
            $("#permission_message").hide();
            $('input[name!="tree[relationship]"]').prop('disabled', false);
          }
        }
        $("#propertyowner").hide();
        $("#notpropertyowner").hide();
        $("#tenant").hide();
        $("#friend").hide();
        $('[name="tree[relationship]"]').each(function(i, thing) {
          if (thing.checked == true) {
            toggle(thing.value)
          }
        })
        $('[name="tree[relationship]"]').change(function(evt) {
          toggle(evt.currentTarget.defaultValue)
        });

   <% end %>
    <!-- if the user is a property owner, just include a card with their info -->

    <div id="permission_message">
      If you don't already have permission from the property owner, please go get it first before adding their tree to our directory.
    </div>
    <div id="propertyowner">
      <%= f.fields_for :owner, @tree.owner do |uf| %>
        <%#= uf.hidden_field :id %>
        You, <%= @tree.owner.fname %> <%= @tree.owner.lname %>, are adding a tree found at your property, <%= @tree.owner.address %>.
      <% end %>

    </div>
    <!-- if the user is not a property owner, just include a card with their info -->
    <div id="notpropertyowner">
      <p style="font-weight: bold">
      Please fill out as much information as possible below about the property owner and their property. 
      </p>
      <%= f.fields_for :owner, @tree.owner do |uf| %>
        <%= uf.hidden_field :id %>


    <div id="tenant">

        <fieldset>
          <legend>Name <%= required %></legend>
          <%= uf.text_field :fname, placeholder: 'First', value: "" %><br>
          <%= uf.text_field :lname, placeholder: 'Last', value: "" %>
        </fieldset>

        <div class="field">
          <%= uf.label :email %> <%= required %><br>
          <%= uf.email_field :email, value: "" %>
        </div>

        <div class="field">
          <%= uf.label :phone %>  <%= required %><br>
          <%= uf.phone_field :phone, value: "" %>
        </div>
    </div>


    <div id="friend">
        <fieldset>
          <legend>Name <%= required %></legend>
          <%= uf.text_field :fname, placeholder: 'First' %><br>
          <%= uf.text_field :lname, placeholder: 'Last' %>
        </fieldset>

        <div class="field">
          <%= uf.label :email %> <%= required %><br>
          <%= uf.email_field :email %>
        </div>

        <div class="field">
          <%= uf.label :phone %>  <%= required %><br>
          <%= uf.phone_field :phone %>
        </div>
    </div>
        <div>
          <%= uf.label :home_ward, "City Ward", style: 'font-weight:normal' %>
          <%= uf.collection_select :home_ward, Ward.all, :id, :name, include_blank: true %>
          <span class="hint"><%= link_to 'ward map', 'http://app.toronto.ca/wards/jsp/wards.jsp' %></span>
        </div>

        <%= render layout: 'shared/address_form', locals: { f: uf } do %>
       <% end %>

       <% content_for :js_ready do %>
          $("#bad_geocode").hide();
       <% end %>
       <div id="bad_geocode" class="note">
          We couldnt find that address on a map. Could you put directions below in Property Notes and a street address (e.g. 123 Yonge St. Toronto, ON) above? 
       </div>

      <div class="field">
        <%= uf.label :propertynotes, "Property Notes" %>  <%= required %><br>
        <%= uf.text_area :propertynotes %>
      </div>



      <fieldset>
        <legend>Do have a ladder on the property?</legend>
          <label style="margin:0 0.7em"><%= uf.radio_button :ladder, :yes %>Yes</label>
          <label style="margin:0 0.7em"><%= uf.radio_button :ladder, :borrow %>I can borrow one from a neighbour</label>
          <label style="margin:0 0.7em"><%= uf.radio_button :ladder, :no %>No</label>
      </fieldset>





    <% end %>
  </div>

<%= end_cols %>

<% end %>
